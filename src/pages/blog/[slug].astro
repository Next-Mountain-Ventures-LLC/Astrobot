---
import BaseLayout from "@/layouts/BaseLayout.astro";
import BlogPost from "@/components/blog/BlogPost.astro";
import { getPosts, getPostBySlug, getPostsWithMetadata } from "@/lib/wordpress";
import { generateExcerpt, cleanHtmlForDisplay } from "@/lib/utils";
import RelatedPosts from "@/components/blog/RelatedPosts.astro";
import {
  syncPostsWithManifest,
  readPreviousManifest,
} from "@/lib/build-utils";

// This defines the dynamic paths that will be pre-rendered at build time
export async function getStaticPaths() {
  try {
    console.log("üî® Astro: Starting blog page generation...");

    // Get posts with metadata about whether we're using fallback
    const postsResult = await getPostsWithMetadata(1, 100);
    const allPosts = postsResult.posts;

    console.log(`üî® Astro: Generating ${allPosts.length} blog post pages from WordPress API`);

    // Warn if we seem to be falling back to mock data
    if (allPosts.length <= 3) {
      console.warn(`‚ö†Ô∏è Astro: Only ${allPosts.length} posts found! This might indicate a WordPress API failure.`);
      console.warn('‚ö†Ô∏è Astro: The site may be using mock/fallback data instead of live WordPress content.');
      console.warn('‚ö†Ô∏è Astro: Check that WordPress API is accessible and the "astrobot-design" category exists.');
    }

    // ==================== POST SYNC & CLEANUP ====================
    console.log('\n');

    // Get previous post count for safety check
    const previousManifest = readPreviousManifest();
    const previousPostCount = previousManifest?.totalCount || 0;

    // Perform full sync: compare manifests, delete orphaned posts, write new manifest
    const syncResult = syncPostsWithManifest(
      allPosts,
      postsResult.categoryId,
      postsResult.categorySlug,
      postsResult.usingFallback,
      previousPostCount
    );

    // Log sync summary
    console.log(`\nüìà Final counts: ${allPosts.length} posts after sync`);
    if (syncResult.deletedCount > 0) {
      console.log(`   ‚îî‚îÄ Deleted ${syncResult.deletedCount} orphaned post(s)`);
    }
    console.log('');
    // ==================== END POST SYNC ====================

    // Create a path for each post
    return allPosts.map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
  } catch (error) {
    console.error("‚ùå Astro: Error generating static paths:", error);
    return [];
  }
}

// Get the post for this page and all posts for related posts component
const { post } = Astro.props;

// Get all posts for related posts functionality
const allPosts = await getPosts(1, 100);

// For SEO
const metaDescription = generateExcerpt(post.excerpt, 160);

// Convert the featuredMedia URL to a URL object for OG image
let ogImage;
if (post.featuredMedia?.url) {
  ogImage = new URL(post.featuredMedia.url);
}
---

<BaseLayout
  title={`${cleanHtmlForDisplay(post.title)} | Astrobot.design Blog`}
  description={metaDescription}
  ogImage={ogImage}
>
  <BlogPost post={post} allPosts={allPosts} />

{allPosts.length > 0 && (
  <div class="container mx-auto px-4 pb-16">
    <div class="max-w-3xl mx-auto">
      <RelatedPosts currentPost={post} allPosts={allPosts} />
    </div>
  </div>
)}
</BaseLayout>
